//* =======================================
//* Populating element values from selected data object
//* generated by first request to server.
//* Sections: tabe11
//* =======================================

import {
  tabeForm,
  tabeLevels,
  tabeMode,
  tabeType,
  staffList,
  createOptionList,
  createStaffList,
  scaleScore
} from "../main.js";
// Initializing Luxon DateTime class for the module
const DT = luxon.DateTime;

export const createTabeContent = (list) => {
  let tableBodyContent = [];
  const { FiscalYear } = createCredentials();
  const orderedList = list.sort((record1, record2) =>
    // DT#fromFormat <== Luxon method, "D" token describes mm/dd/yyyy format
    DT.fromFormat(record1.TABEDate, "D") > DT.fromFormat(record2.TABEDate, "D")
      ? -1
      : DT.fromFormat(record1.TABEDate, "D") <
        DT.fromFormat(record2.TABEDate, "D")
      ? 1
      : 0
  );
  for (const record of orderedList) {
    const {
      ID,
      TABEDate,
      TestType,
      TestForm,
      TestLevel,
      Pre_Post,
      TestMode,
      SubScore1,
      ScaleScore,
      NRSLevel,
      Personnel_PKID
    } = record;
    const optionListType = createOptionList(tabeType, TestType);
    const optionListForm = createOptionList(tabeForm, TestForm);
    const optionListLevel = createOptionList(tabeLevels, TestLevel);
    const optionListMode = createOptionList(tabeMode, TestMode);
    const optionListStaff = createOptionList(
      createStaffList(staffList),
      Personnel_PKID
    );
    const row = `
    <tr id=${ID} data-original-title="Click to Edit" data-toggle="tooltip" data-placement="left" >
      <td>
        <div class="form-group input-field">
          <input type="text" disabled name="TABEDate" value=${TABEDate}>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <select class="modal-select" disabled name="TestType">
            ${optionListType}
          </select>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <select class="modal-select" disabled name="TestForm">
          <option></option>
            ${optionListForm}
          </select>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <select class="modal-select" disabled name="TestLevel">
          <option></option>
            ${optionListLevel}
          </select>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <input type="text" disabled name="Pre_Post" value=${Pre_Post}>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <select class="modal-select" disabled name="TestMode">
          <option></option>
            ${optionListMode}
          </select>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <input  type="text" disabled name="SubScore1" value=${SubScore1}>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
        <input type="text" disabled name="ScaleScore" value=${ScaleScore}>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <input type="text" disabled name="NRSLevel" value=${NRSLevel}>
        </div>
      </td>
      <td>
        <div class="form-group input-field">
          <select class="modal-select" disabled name="Personnel_PKID">
            ${optionListStaff}
          </select>
        </div>
      </td>
    </tr>
  `;
    tableBodyContent.push(row);
  }
  return tableBodyContent.join("");
};

export const addNewTabeTest = (obj) => {
  const content = [];
  const { labels } = obj;
  let labelClassVal = "";
  let classVal = "";
  for (const keyValue in labels) {
    const labelVal = labels[keyValue];
    let row = "";
    let option = "";
    let value = "";
    // <input> fields process
    if (
      ["TABEDate", "Pre_Post", "SubScore1", "ScaleScore", "NRSLevel"].includes(
        keyValue
      )
    ) {
      let optionHidden = "form-group";
      if (["Pre_Post", "ScaleScore", "NRSLevel"].includes(keyValue)) {
        option = "disabled";
      }
      const type = keyValue.includes("Date") ? "date" : "text";
      // elementInput() ==> helpers/helperFunctions.js
      row = elementInput({
        keyVal: keyValue,
        labelVal,
        value,
        labelClassVal,
        classVal,
        option,
        optionHidden,
        type
      });
    } else {
      // <select> fields process
      let hashTable;
      switch (keyValue) {
        case "TestType":
          hashTable = tabeType;
          break;
        case "TestForm":
          hashTable = tabeForm;
          break;
        case "TestLevel":
          hashTable = tabeLevels;
          break;
        case "TestMode":
          hashTable = tabeMode;
          break;

        default:
          hashTable = createStaffList(staffList);
          break;
      }
      // elementSelectModal() ==> helpers/helperFunction.js
      row = elementSelectModal({
        hashTable,
        keyValue,
        selectedValue: "",
        labelVal,
        labelClassVal,
        option,
        optionText: ""
      });
    }
    content.push(row);
  }
  return content.join("");
};

export const updateTABEScore = ([type, form, level, mode, score]) => {
  // Test score is evaluated depending on test level (GetLevel_TABE11).
  // Each level has a range Min/Max for the score value to be valid.
  // Different test types have different test score ranges
  const evalTR = (testLevel, testScore, reference) => {
    const list = [...reference[testLevel], Number(testScore)];
    const indx = list.sort((num1, num2) => num1 - num2).lastIndexOf(testScore);
    return indx === 1 ? indx : 0;
  };
  const evalTM = (testLevel, testScore, reference) => {
    const list = [...reference[testLevel], Number(testScore)];
    const indx = list.sort((num1, num2) => num1 - num2).lastIndexOf(testScore);
    return indx === 1 ? indx : 0;
  };
  const numScore = Number(score);
  let flag = 1; // Changed flag value to 1 if in range and 0 if out of range
  switch (type) {
    case "ML":
    case "RL":
      if (numScore > 50) flag = 0;
      break;
    case "TR":
      flag = evalTR(level, numScore, referenceTR[0]);
      break;
    case "TM":
      const referenceObj = form === "11" ? referenceTM11[0] : referenceTM12[0];
      flag = evalTM(level, numScore, referenceObj);
      break;
    default:
      flag = 0;
      break;
  }
  if (!flag) {
    $("#edit-form input[name='SubScore1']")
      .css("background-color", "#f7e095")
      .focus();
    return false;
  } else {
    const key = type + form + level + score;
    //! =========================================
    //! For Production
    //! =========================================
    // const dbScore = await scaleScore(key, mode);
    //! =========================================

    //! =========================================
    //! For Development ONLY
    //! Comment out for production
    //! =========================================
    const dbScore = scaleScore;
    //! =========================================

    return dbScore;
  }
};
